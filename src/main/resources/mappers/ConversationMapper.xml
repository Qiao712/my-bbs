<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="sdu.addd.qasys.mapper.ConversationMapper">
    <resultMap id="conversationMap" type="Conversation">
        <id property="id" column="id"/>
        <association property="lastMessage" column="last_message_id" select="selectPrivateMessage"/>
    </resultMap>

    <select id="selectConversations" resultMap="conversationMap">
        SELECT * FROM t_conversation
        WHERE user1_id = #{userId} OR user2_id = #{userId}
        ORDER BY last_message_time DESC
    </select>

    <select id="selectPrivateMessage" resultType="PrivateMessage">
        SELECT * FROM t_private_message WHERE id = #{id}
    </select>

    <select id="selectUnreadNumber" resultType="Long">
        SELECT ifnull(t1.unread, 0) + ifnull(t2.unread, 0) FROM
            (SELECT SUM(unread_num1) unread FROM t_conversation WHERE user1_id = #{receiverId}) as t1,
            (SELECT SUM(unread_num2) unread FROM t_conversation WHERE user2_id = #{receiverId}) as t2
    </select>
</mapper>
